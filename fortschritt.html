<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fortschritt - BW Fahrschul-Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-slate-800 font-sans antialiased pb-10">

    <div class="max-w-2xl mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col">

        <header class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-md flex items-center">
            <button onclick="window.location.href='index.html'" type="button" class="mr-4 p-2 bg-slate-700 rounded-full hover:bg-slate-600 active:scale-95">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div>
                <h1 class="text-xl font-bold tracking-wide">Schüler-Fortschritt</h1>
                <p class="text-xs text-slate-300">Aktueller Leistungsstand & Historie</p>
            </div>
        </header>

        <main class="flex-1 p-5">
            
            <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Schüler-ID auswählen</label>
                <select id="schuelerSelect" onchange="ladeFortschritt()" class="w-full p-3 rounded-lg border border-slate-300 bg-white font-bold text-slate-800 text-lg">
                    </select>
            </div>

            <div id="ergebnisBereich" class="hidden">
                
                <h2 class="text-lg font-bold text-blue-900 mb-4 border-b-2 border-blue-200 pb-1">Ampel-Status (68 Kriterien)</h2>

                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-green-50 border border-green-200 p-3 rounded-xl text-center shadow-sm">
                        <div class="text-2xl font-black text-green-600" id="countGruen">0</div>
                        <div class="text-[10px] font-bold text-green-800 uppercase tracking-wide mt-1">Sicher (Grün)</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-xl text-center shadow-sm">
                        <div class="text-2xl font-black text-yellow-600" id="countGelb">0</div>
                        <div class="text-[10px] font-bold text-yellow-800 uppercase tracking-wide mt-1">Hilfe (Gelb)</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 p-3 rounded-xl text-center shadow-sm">
                        <div class="text-2xl font-black text-red-600" id="countRot">0</div>
                        <div class="text-[10px] font-bold text-red-800 uppercase tracking-wide mt-1">Defizit (Rot)</div>
                    </div>
                </div>

                <div class="mb-8 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-sm font-bold text-slate-700">Prüfungsreife (Grüne Kriterien)</span>
                        <span class="text-lg font-black text-blue-700" id="prozentText">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                        <div id="prozentBalken" class="bg-blue-600 h-4 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                </div>

                <h2 class="text-lg font-bold text-red-900 mb-3 border-b-2 border-red-200 pb-1">Aktuelle Schwerpunkte (Rot)</h2>
                <div id="roteListe" class="bg-white border border-red-100 rounded-xl shadow-sm divide-y divide-red-50 mb-8">
                    </div>

                <h2 class="text-lg font-bold text-slate-800 mb-3 border-b-2 border-slate-300 pb-1">Historie (Notizen)</h2>
                <div id="notizenHistorie" class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden divide-y divide-slate-100">
                    </div>

            </div>

        </main>
    </div>

    <script>
        const alleFahrten = JSON.parse(localStorage.getItem('bw_ausbildungsstand')) || [];
        const selectBox = document.getElementById('schuelerSelect');
        const ids = [...new Set(alleFahrten.map(f => f.schuelerId))].filter(id => id);

        // Das "Wörterbuch" mit allen 68 Kriterien-Texten, damit nicht nur "Kriterium 1" dasteht
        const kriterienKatalog = [
            "Einweisung in das Ausbildungsfahrzeug", "Techn. Durchsichten", "Ladungssicherung", "Fahrtechn. Vorbereitungen", "Handhabung Bedienungseinrichtung", "Bedienung EG-Kontrollgerät", "Anfahr-, Schalt- und Lenkübungen", "Fahren mit geringer Geschwindigkeit", "Abbremsen aus geringer Geschw.", "Rückwärtsfahren mit Einweiser", "An- und Abkuppeln des Anhängers", "Maßnahmen beim Verlassen",
            "Verhalten beim Anfahren", "Gangwechsel", "Fahrbahnbenutzung", "Abbiegen an Kreuzungen", "Fahrstreifenwechsel", "Beobachtung Verkehrsraum", "Verkehrszeichen", "Geschwindigkeit", "Sicherheitsabstände", "Überholen und Vorbeifahren", "- durch Lichtzeichen", "- mit und ohne Verkehrszeichen", "Kreisverkehr", "Bahnübergänge", "Gegenüber Fußgängern/Radfahrern", "Fußgängerüberwege", "Verkehrsberuhigte Bereiche", "Öffentliche Verkehrsmittel", "Durchfahren von Engstellen", "Warneinrichtungen", "Sicherung liegengebliebener Fzg",
            "Wenden und Rückwärtsfahren (DFE)",
            "Fahren auf Feld-, Wald-, Wiesenwegen", "Bodenverhältnisse", "Materialschonendes Fahren", "Geschwindigkeit und Gangwahl", "Geländegang / Getriebesperren", "Befahren von Fahrspuren", "Gefahrbremsung (mit ABV)", "Ausweichen von Hindernissen", "Steigungen und Gefälle", "Überwinden von Querrinnen", "Geländebeurteilung", "Rückwärts in Parklücke", "Rückwärts quer einparken", "Rückwärts unter Ausnutzung Einmündung", "Rückwärts an Rampe", "Abfahrtkontrolle", "Rückwärts geradeaus Rampe", "Umkehren durch Rückwärtsfahren", "Sicherheitskontrolle", "Verbinden und Trennen", "Abstellen des Anhängers",
            "Vorausschauendes Fahren", "Beobachtung Verkehrsteilnehmer", "Beobachtung Fahrverhalten anderer", "Beobachtung Verkehrsraum", "Bremsen in Gefahrensituationen", "Überlandfahrten", "Autobahn", "Dunkelheit",
            "Verhalten in komplizierten Situationen", "Vermeiden risikoreicher Situationen", "Fahren in unbekannten Räumen", "Fahren unter Prüfungsbedingungen", "Feststellen der Prüfungsreife"
        ];

        if (ids.length === 0) {
            selectBox.innerHTML = '<option value="">Keine Daten erfasst.</option>';
            selectBox.disabled = true;
        } else {
            selectBox.innerHTML = '<option value="" disabled selected>Bitte wählen...</option>';
            ids.forEach(id => selectBox.innerHTML += `<option value="${id}">${id}</option>`);
        }

        function ladeFortschritt() {
            const id = selectBox.value;
            if (!id) return;
            document.getElementById('ergebnisBereich').classList.remove('hidden');

            const fahrten = alleFahrten.filter(f => f.schuelerId === id).sort((a, b) => new Date(a.datum) - new Date(b.datum));
            const stand = {};
            
            // Ermittelt für jedes "item_X" den finalen/letzten Stand
            fahrten.forEach(f => {
                for (const [key, val] of Object.entries(f)) {
                    if (val === 'rot' || val === 'gelb' || val === 'gruen') stand[key] = val;
                }
            });

            let a = 0, b = 0, c = 0; const defizite = [];
            for (const [key, val] of Object.entries(stand)) {
                if (val === 'gruen') c++; 
                if (val === 'gelb') b++;
                if (val === 'rot') { 
                    a++; 
                    // Liest die Nummer aus dem Schlüssel (z.B. "item_14" -> "14")
                    let nr = parseInt(key.split('_')[1]);
                    // Holt den echten Text aus unserem Wörterbuch (-1 weil Arrays bei 0 anfangen)
                    let echterText = kriterienKatalog[nr - 1] || "Unbekanntes Kriterium";
                    defizite.push(`${nr}. ${echterText}`); 
                }
            }

            document.getElementById('countGruen').textContent = c;
            document.getElementById('countGelb').textContent = b;
            document.getElementById('countRot').textContent = a;
            
            const proz = Math.round((c / 68) * 100);
            document.getElementById('prozentBalken').style.width = `${proz}%`;
            document.getElementById('prozentText').textContent = `${proz}%`;

            const defBox = document.getElementById('roteListe');
            defBox.innerHTML = defizite.length ? '' : '<div class="p-4 text-sm text-slate-500 italic text-center">Keine kritischen Defizite vorhanden.</div>';
            
            defizite.forEach(d => {
                defBox.innerHTML += `
                <div class="p-3 flex items-center">
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-3 shrink-0"></div>
                    <span class="text-sm font-bold text-slate-700">${d}</span>
                </div>`;
            });

            const notizBox = document.getElementById('notizenHistorie');
            notizBox.innerHTML = ''; let hatNotiz = false;
            
            [...fahrten].reverse().forEach(f => {
                const dat = new Date(f.datum).toLocaleDateString('de-DE');
                let t = '';
                
                const labels = {
                    'notizen_grundstufe': 'Grundstufe',
                    'notizen_aufbauA': 'Aufbaustufe A',
                    'notizen_dfe': 'DFE',
                    'notizen_aufbauC': 'Aufbaustufe B/C',
                    'notizen_leistung': 'Leistung',
                    'notizen_reifestufe': 'Reife / Einweiser'
                };

                for (const [key, label] of Object.entries(labels)) {
                    if(f[key] && f[key].trim() !== '') {
                        t += `<p class="mt-1 text-sm text-slate-700"><span class="font-bold text-blue-800">${label}:</span> ${f[key]}</p>`;
                    }
                }

                if(t) { 
                    hatNotiz = true; 
                    notizBox.innerHTML += `
                    <div class="p-4">
                        <div class="text-[10px] font-bold text-slate-400 bg-slate-100 inline-block px-2 py-0.5 rounded uppercase tracking-wider mb-1">Eintrag vom ${dat}</div>
                        ${t}
                    </div>`; 
                }
            });
            
            if(!hatNotiz) notizBox.innerHTML = '<div class="p-4 text-sm text-slate-500 italic text-center">Bisher keine Notizen erfasst.</div>';
        }
    </script>
</body>
</html>
