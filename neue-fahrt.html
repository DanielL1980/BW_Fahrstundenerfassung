<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ausbildungsstand - BW Fahrschul-Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="radio"].ampel-radio { display: none; }
        input[type="radio"].ampel-radio:checked + label {
            opacity: 1; transform: scale(1.1); border: 3px solid white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .ampel-label { opacity: 0.25; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary { border-bottom: 2px solid #f1f5f9; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .row-hidden { display: none !important; }
        /* Style für die Zwischenüberschriften im Menü */
        .sub-header { background-color: #f8fafc; border-left: 4px solid #cbd5e1; padding: 8px 12px; margin: 12px 0 4px 0; font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased pb-32">

    <div class="max-w-2xl mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col">

        <header class="bg-slate-800 text-white p-5 sticky top-0 z-50 shadow-lg flex items-center justify-between border-b-4 border-emerald-500">
            <div class="flex items-center">
                <button onclick="window.location.href='index.html'" type="button" class="mr-4 p-2 bg-slate-700 rounded-xl hover:bg-slate-600 active:scale-95 transition-all">
                    <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div>
                    <h1 class="text-xl font-black tracking-tight uppercase italic">Dokumentation</h1>
                    <p class="text-[10px] text-emerald-300 font-bold uppercase tracking-widest">Fahrt & Ausbildungsstand</p>
                </div>
            </div>
        </header>

        <main class="flex-1 p-5">
            <form id="fahrtForm" onsubmit="saveFahrt(event)">
                
                <div class="mb-8 bg-slate-100 p-5 rounded-2xl border border-slate-200 shadow-inner space-y-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 mb-1 uppercase tracking-widest">Fahrschüler</label>
                        <select name="schuelerId" id="schuelerSelect" required onchange="ladeBestehendenStand()" class="w-full p-3 rounded-xl border-2 border-white bg-white font-black text-slate-800 shadow-sm outline-none focus:border-emerald-500 transition-all"></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 mb-1 uppercase tracking-widest">DFE Klasse auswählen</label>
                        <select name="dfeKlasse" id="dfeKlasse" onchange="applyDFEFilter()" class="w-full p-3 rounded-xl border-2 border-emerald-200 bg-emerald-50 font-black text-emerald-900 shadow-sm outline-none focus:border-emerald-500 transition-all">
                            <option value="C/CE">Klasse C / CE (Gesamt)</option>
                            <option value="C">Klasse C (Nur Solo)</option>
                            <option value="E für C">Klasse E für C (Anhänger)</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end mb-3 pr-2 opacity-50">
                    <div class="flex gap-14 mr-4">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Zyklen</span>
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Bewertung</span>
                    </div>
                </div>

                <div class="space-y-4" id="formContent"></div>

                <div class="fixed bottom-0 left-0 w-full p-6 bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-xl z-50">
                    <div class="max-w-2xl mx-auto">
                        <button type="submit" class="w-full bg-slate-800 text-white font-black text-lg py-5 rounded-2xl shadow-xl active:scale-95 transition-all uppercase tracking-widest border-b-4 border-emerald-600">
                            Dokumentation Speichern
                        </button>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <script>
        const katalog = {
            grundstufe: ["Einweisung in das Ausbildungsfahrzeug", "Techn. Durchsichten (vor, während, nach der Benutzung)", "Ladungssicherung (Ladung, Zubehör und pers. Ausrüstung)", "Fahrtechn. Vorbereitungen (Sitz/Spiegel / Lenkrad/Gurt)", "Handhabung der Bedienungseinrichtung", "Bedienung EG-Kontrollgerät", "Anfahr-, Schalt- und Lenkübungen", "Fahren mit geringer Geschwindigkeit", "Abbremsen aus geringer Geschwindigkeit", "Rückwärtsfahren mit Einweiser / Sicherungsposten", "An- und Abkuppeln des Anhängers", "Maßnahmen beim Verlassen des Fahrzeugs"],
            aufbauA: ["Verhalten beim Anfahren (Ebene/Steigung/Gefälle)", "Gangwechsel", "Fahrbahnbenutzung (Kurven/ein- und mehrspurig)", "Abbiegen an Kreuzungen / Einmündungen", "Fahrstreifenwechsel", "Beobachtung Verkehrsraum", "Beachten der Verkehrszeichen und -einrichtungen", "Geschwindigkeit (Straßen-/Verkehrsverhältnisse)", "Sicherheitsabstände", "Überholen und Vorbeifahren", "Regelung durch Lichtzeichen oder Polizeibeamte", "mit und ohne Verkehrszeichen", "Verhalten am und im Kreisverkehr", "Verhalten an Bahnübergängen", "Verhalten gegenüber Fußgängern und Radfahrern", "Verhalten an Fußgängerüberwegen", "Verhalten in verkehrsberuhigten Bereichen", "Haltende öffentliche Verkehrsmittel u. Schulbusse", "Durchfahren von Engstellen", "Benutzung der Warneinrichtungen", "Maßnahmen zur Sicherung liegengebliebener fzg"],
            dfe: ["Wenden und Rückwärtsfahren mit und ohne Anhänger"],
            aufbauB: ["Fahren auf Feld-, Wald-, und Wiesenwegen", "Fahren auf unterschiedlichen Bodenverhältnissen", "Materialschonendes Fahren", "Geschwindigkeit und Gangwahl", "Fahren ohne und mit Geländegang / Getriebesperren", "Befahren von Fahrspuren, Lenkradhaltung", "Gefahrbremsung auf unbefestigten Wegen (mit ABV)", "Ausweichen von Hindernissen", "Befahren von Steigungen und Gefällen", "Überwinden von Querrinnen / Bodenunebenheiten", "Geländebeurteilung /-ausnutzung"],
            aufbauC: ["Rückwärtsfahren in eine Parklücke (Längsaufstellung)", "Rückwärts quer oder schräg einparken", "Fahren nach rechts rückwärts unter Ausnutzung einer Einmündung, Kreuzung oder Einfahrt", "Rückwärtsfahren und Versetzen nach rechts an eine Rampe zum Be- oder Entladen", "Abfahrtkontrolle (Sachgebiete 1-6)", "Rückwärtsfahren geradeaus an eine Rampe zum Be- oder Entladen", "Umkehren durch Rückwärtsfahren nach links", "Sicherheitskontrolle", "Verbinden und Trennen von Fahrzeugen", "Abstellen des Anhängers"],
            leistung: ["Vorausschauendes Fahren", "Beobachtung anderer Verkehrsteilnehmer", "Beobachtung des Fahrverhaltens anderer fzfhr", "Beobachtung des Verkehrsraums", "Bremsen in Gefahrensituationen", "Schulung auf Bundes- oder Landstraßen", "Schulung auf Autobahnen", "Schulung bei Dämmerung oder Dunkelheit"],
            reife: ["Verhalten in komplizierten Verkehrssituationen", "Vermeiden risikoreicher Verkehrssituationen", "Fahren in unbekannten Verkehrsräumen", "Fahren unter Prüfungsbedingungen", "Feststellen der Prüfungsreife", "Einweisertätigkeit bei Tag", "Einweisertätigkeit bei Nacht"]
        };

        const titles = { grundstufe: "Grundstufe (1-12)", aufbauA: "Aufbau A (13-33)", dfe: "DFE (34)", aufbauB: "Aufbau B - Leichtes Gelände (35-45)", aufbauC: "Aufbau C - Manöver (46-55)", leistung: "Leistung (56-63)", reife: "Reife / Einweiser (64-70)" };

        function generateRow(nr, text) {
            const isEinweiser = (nr >= 69);
            const isManualAllowed = (nr <= 68);
            const maxVal = (nr === 69) ? 2 : (nr === 70) ? 1 : 99;
            
            // Zwischenüberschriften Logik
            let extraHeader = "";
            if (nr === 46) extraHeader = `<div class="sub-header">Grundfahraufgaben DFE Kl. C</div>`;
            if (nr === 51) extraHeader = `<div class="sub-header">Grundfahraufgaben DFE Kl. CE</div>`;

            return `
            ${extraHeader}
            <div id="row-${nr}" class="flex items-center justify-between py-4 border-b border-slate-50 last:border-0 group">
                <span class="text-xs font-bold text-slate-600 w-1/2 pr-2 leading-tight">${nr}. ${text}</span>
                <div class="flex items-center justify-end w-1/2 space-x-4">
                    <div class="flex items-center bg-slate-100 rounded-xl p-1 border border-slate-200">
                        <button type="button" onclick="changeCount(${nr}, -1, ${maxVal})" class="w-7 h-7 bg-white rounded-lg shadow-sm flex items-center justify-center font-black text-slate-400">-</button>
                        <input type="number" name="count_${nr}" id="count_${nr}" value="0" 
                            class="w-8 text-center bg-transparent font-black text-xs text-slate-700 outline-none" 
                            ${isManualAllowed ? "" : "readonly"} 
                            oninput="validateInput(${nr}, ${maxVal})">
                        <button type="button" onclick="changeCount(${nr}, 1, ${maxVal})" class="w-7 h-7 bg-white rounded-lg shadow-sm flex items-center justify-center font-black text-slate-600">+</button>
                    </div>
                    ${!isEinweiser ? `<div class="flex space-x-2">
                        <input type="radio" name="item_${nr}" id="i${nr}_rot" value="rot" class="ampel-radio"><label for="i${nr}_rot" class="ampel-label w-7 h-7 rounded-full bg-rose-500 cursor-pointer shadow-sm"></label>
                        <input type="radio" name="item_${nr}" id="i${nr}_gelb" value="gelb" class="ampel-radio"><label for="i${nr}_gelb" class="ampel-label w-7 h-7 rounded-full bg-amber-400 cursor-pointer shadow-sm"></label>
                        <input type="radio" name="item_${nr}" id="i${nr}_gruen" value="gruen" class="ampel-radio"><label for="i${nr}_gruen" class="ampel-label w-7 h-7 rounded-full bg-emerald-500 cursor-pointer shadow-sm"></label>
                    </div>` : `<div class="w-[92px]"></div>`}
                </div>
            </div>`;
        }

        function validateInput(nr, max) {
            const inp = document.getElementById(`count_${nr}`);
            let val = parseInt(inp.value);
            if (isNaN(val) || val < 0) inp.value = 0;
            if (val > max) inp.value = max;
        }

        function renderAll() {
            const main = document.getElementById('formContent');
            main.innerHTML = ''; let currentNr = 1;
            ['grundstufe', 'aufbauA', 'dfe', 'aufbauB', 'aufbauC', 'leistung', 'reife'].forEach(key => {
                let html = `<details id="section-${key}" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-4">
                    <summary class="p-5 font-black text-xs text-slate-500 bg-slate-50/50 cursor-pointer flex justify-between items-center uppercase tracking-widest">${titles[key]} <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2"></path></svg></summary>
                    <div class="p-5">`;
                katalog[key].forEach(text => { html += generateRow(currentNr, text); currentNr++; });
                html += `<textarea name="notizen_${key}" rows="2" placeholder="Notizen..." class="w-full mt-4 p-4 text-sm rounded-xl bg-slate-50 border border-slate-100 italic outline-none"></textarea></div></details>`;
                main.innerHTML += html;
            });
        }

        function ladeBestehendenStand() {
            const id = document.getElementById('schuelerSelect').value; if(!id) return;
            const allRadios = document.querySelectorAll('input[type="radio"]');
            allRadios.forEach(r => r.checked = false);
            const allCounts = document.querySelectorAll('input[type="number"]');
            allCounts.forEach(c => c.value = 0);
            const allNotes = document.querySelectorAll('textarea');
            allNotes.forEach(n => n.value = '');

            const alleFahrten = JSON.parse(localStorage.getItem('bw_ausbildungsstand')) || [];
            const schuelerFahrten = alleFahrten.filter(f => f.schuelerId === id).sort((a,b) => new Date(a.datum) - new Date(b.datum));
            schuelerFahrten.forEach(f => {
                for(let i=1; i<=70; i++) {
                    if(f[`item_${i}`]) { const rb = document.getElementById(`i${i}_${f['item_'+i]}`); if(rb) rb.checked = true; }
                    if(f[`count_${i}`]) { const inp = document.getElementById(`count_${i}`); if(inp) inp.value = parseInt(inp.value) + parseInt(f[`count_${i}`]); }
                }
            });
            applyDFEFilter();
        }

        function changeCount(nr, val, max) { 
            const inp = document.getElementById(`count_${nr}`); 
            let newVal = (parseInt(inp.value) || 0) + val; 
            if (newVal >= 0 && newVal <= max) inp.value = newVal; 
        }
        
        function applyDFEFilter() {
            const klasse = document.getElementById('dfeKlasse').value;
            for(let i=1; i<=70; i++) { if(document.getElementById(`row-${i}`)) document.getElementById(`row-${i}`).classList.remove('row-hidden'); }
            if (klasse === 'C') { for(let i=51; i<=55; i++) { if(document.getElementById(`row-${i}`)) document.getElementById(`row-${i}`).classList.add('row-hidden'); } }
            else if (klasse === 'E für C') { 
                // In der neuen Logik: Verstecke Aufbau B (35-45) und die ersten Manöver von C (46-50)
                for(let i=35; i<=50; i++) { if(document.getElementById(`row-${i}`)) document.getElementById(`row-${i}`).classList.add('row-hidden'); } 
                document.getElementById('section-dfe').classList.add('row-hidden'); 
            }
        }

        const ids = JSON.parse(localStorage.getItem('bw_aktive_schueler')) || [];
        const select = document.getElementById('schuelerSelect');
        if (ids.length > 0) { 
            select.innerHTML = '<option value="" disabled selected>Fahrschüler auswählen...</option>'; 
            ids.forEach(id => select.innerHTML += `<option value="${id}">${id}</option>`); 
        } else { select.innerHTML = '<option value="">Keine Schüler vorhanden!</option>'; }

        renderAll();

        function saveFahrt(event) {
            event.preventDefault(); 
            const formData = new FormData(event.target); 
            const data = Object.fromEntries(formData.entries()); 
            data.datum = new Date().toISOString();
            if(data.count_69) data.item_69_minuten = (parseInt(data.count_69) >= 2) ? 90 : (parseInt(data.count_69) == 1 ? 45 : 0);
            if(data.count_70) data.item_70_minuten = (parseInt(data.count_70) >= 1) ? 45 : 0;
            let arr = JSON.parse(localStorage.getItem('bw_ausbildungsstand')) || []; 
            arr.push(data); 
            localStorage.setItem('bw_ausbildungsstand', JSON.stringify(arr)); 
            alert('✅ Stand aktualisiert!'); 
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
